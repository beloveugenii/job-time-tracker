#!/usr/bin/env python3

import sqlite3, readline, sys, re, datetime
from ui import *
from libjtt import *
from init_db import *

menu_entries = ('add', 'configure', 'help', 'next month', 'previous month', 'quit')
# НОВЫЕ ФУНКЦИИ


#  actions = { #'a': lambda args:
            #  'q': ex(0),
            #  'p': change_period(cur, current_period, direction)
            #  #  'p': lambda: print((datetime.date.today() - datetime.timedelta(31)).isoformat()),
            #  #  'n': lambda: print((datetime.date.today() + datetime.timedelta(31)).isoformat()),
            #  'default': lambda: print('Неизвестная команда'),
           #  }











PROG_NAME = 'job-time-tracker'
VERSION = '0.1.1.3'
DB_NAME = sys.path[0] + '/data.db'

#  readline.set_completer_delims('\n,')
readline.parse_and_bind('tab: complete')

con = sqlite3.connect(DB_NAME)
cur = con.cursor()

create_tables(cur)
con.commit()

while True:
    # Пытаемся получить значение выбранного периода времени из БД
    current_period = (cur.execute('SELECT selected_period FROM config').fetchone())

    if current_period is None:
    # Если нет записанного значения - получаем текущий месяц в виде ГГГГ-ММ
        current_period = (cur.execute("SELECT date()").fetchone())[0][:7]
        # и записываем его в БД
        cur.execute('INSERT INTO config VALUES(?)', (current_period, ))
        con.commit()

    else:
        # Если получилось получить значение из БД, приводим его к виду ГГГГ-ММ
        current_period = current_period[0]
    
    changed = False
    
    # Пытаемся получить строки данных за выбранный период времени
    period_data = get_period_data(cur, current_period)    
    # И конфигурацию текущего выбранного периода времени
    period_params = get_period_params(cur, current_period)
    

    if period_params is None:
        period_params = get_default_params(cur, current_period)


    # Вывод на экран
    clear()
    header(' '.join((PROG_NAME, VERSION, ':', pretty_period(current_period))))
    
    if period_params is not None:
        print_as_table(calculate(period_params, period_data), ' ')
        line() 

    print_as_table(period_data, ' ') if period_data else print('Нет данных за указанный период...')

    menu(menu_entries, 3)

    


    readline.set_completer(Completer([item[0] for item in menu_entries] + dd).complete)


   
    action = input('>> ').lower().strip()

    # Вот теперь пора писать парсер комманды, он будет определять что введено и возвращать какое то значение, по которому будет вызываться соответствующая функция

    if action in 'pn':
        changed = change_period(cur, current_period, action)

    elif action == 'q': ex(0)

    elif action == 'h': help('main_help')

    elif action == 'a':
        print('Enter date, dh, nh')
        l = input().strip().split(' ')
        changed = add_data(cur, l)


    else: help('not_impl')

    if changed:
        con.commit()
        changed = False



    



con.close()
clear()





